---
description: Правила для команд и работы с vrunner
globs: src/commands/**/*.ts
alwaysApply: false
---

# Команды и vrunner

## Структура команд

Команды по доменам в `src/commands/`: `infobaseCommands`, `configurationCommands`, `extensionsCommands`, `artifactCommands`, `externalFilesCommands`, `dependenciesCommands`, `runCommands`, `testCommands`, `setVersionCommands`, `workspaceTasksCommands`, `oscriptTasksCommands`. Все классы наследуют **BaseCommand** и используют `this.vrunner`. `ArtifactCommands` — точечная сборка/разборка из дерева «Артефакты 1С» и из editor/title.

## Обязательные паттерны

- **Проверка workspace**: всегда `this.ensureWorkspace()` (не вызывать напрямую `getWorkspaceRoot()`).
- **Выполнение в терминале**: `this.vrunner.executeVRunnerInTerminal(args)`; для проверок — `this.vrunner.executeVRunner()`.
- **ibcmd**: `this.addIbcmdIfNeeded(args)` для добавления `--ibcmd` при необходимости (настройка или Docker).
- **Параметр ИБ**: `await this.vrunner.getIbConnectionParam()` → использовать как `...ibConnectionParam` в аргументах.

## Пути (настройки `1c-platform-tools.paths.*`)

- Исходники конфигурации: `this.vrunner.getCfPath()` (по умолчанию `src/cf`)
- Результаты сборки: `this.vrunner.getOutPath()` (по умолчанию `build/out`)
- Расширения: `getCfePath()` — `src/cfe`; обработки: `getEpfPath()` — `src/epf`; отчёты: `getErfPath()` — `src/erf`
- vrunner: `this.vrunner.getVRunnerPath()` — `oscript_modules/bin/vrunner.bat` в workspace или `vrunner` из PATH

## Docker и ibcmd

- Docker: `await this.vrunner.shouldUseDocker()`; поддержка ibcmd: `this.vrunner.supportsIbcmd(args)`.
- В Docker выполняются только команды, поддерживающие `--ibcmd`; иначе — предупреждение с отменой.
- Нормализация аргументов для Docker: `this.vrunner.processCommandArgsForDocker()`; образ: `this.vrunner.getDockerImage()`.
- Множественные команды: при Docker — каждая через `executeVRunnerInTerminal()`; без Docker — можно `executeCommandsInTerminal()` для последовательного запуска.

## Именование методов

- `compile()` — сборка из исходников в бинарник; `decompile()` — разбор в исходники
- `loadFromSrc()` / `loadFromCf()` / `loadFromCfe()` — загрузка в ИБ; `dumpToSrc()` / `dumpToCf()` / `dumpToCfe()` — выгрузка из ИБ

## Добавление новых команд

Новую команду: добавить запись в соответствующую группу в `src/treeStructure.ts` (TREE_GROUPS), зарегистрировать в `package.json` → `contributes.commands` и в `src/commands/commandRegistry.ts` через `registerCommands()`. Названия — функции из `src/commandNames.ts` (get*CommandName()); для узлов «Конфигурации запуска» (env.json, launch.json) допускаются фиксированные title/treeLabel. Команды для динамических узлов (задачи oscript, конфигурации запуска) регистрируются в extension.ts.

## Навыки для AI (skills)

В дереве «Инструменты 1С» группа **«Навыки для AI»** содержит две кнопки:

1. **«Добавить навыки разработки 1С (cc-1c-skills)»** (`1c-platform-tools.skills.addDevSkills`) — скачивает репозиторий [cc-1c-skills](https://github.com/Nikolay-Shirokov/cc-1c-skills) с GitHub (при каждом вызове, в репо расширения не хранятся), распаковывает архив и копирует **содержимое** `.claude/skills/` в выбранную папку (Для Cursor → `.cursor/skills/`, Для Claude Code → `.claude/skills/`, Указать папку). Навыки: XML, формы, роли, СКД, метаданные, EPF/ERF и т.д. Реализация: `src/commands/skillsCommands.ts` → `addDevSkills()`.

2. **«Добавить навыки расширения (команды и MCP)»** (`1c-platform-tools.skills.add1cpt`) — копирует **все** наши навыки (полный + доменные) **одним действием, без выбора** «какой навык». Пользователь выбирает только «Куда установить» (Cursor / Copilot / Claude / своя папка). Копируются папки из `resources/skills/`: `1c-platform-tools`, `1c-platform-tools-configuration`, `1c-platform-tools-extensions`, `1c-platform-tools-infobase`, `1c-platform-tools-external`, `1c-platform-tools-run`, `1c-platform-tools-test`, `1c-platform-tools-dependencies`, `1c-platform-tools-support`, `1c-platform-tools-setversion`, `1c-platform-tools-config`, `1c-platform-tools-mcp`. Реализация: `add1cptSkills()` в skillsCommands.ts.

**При добавлении новой команды в код** (TREE_GROUPS и commandRegistry) обязательно обновить навыки:

- Добавить строку в таблицу «Задача | Command ID» в **полном** навыке `resources/skills/1c-platform-tools/SKILL.md` в соответствующую секцию (Информационные базы, Конфигурация, Расширения и т.д.).
- Если команда относится к одному из доменов, добавить или обновить запись в доменном навыке `resources/skills/1c-platform-tools-<domain>/SKILL.md`: configuration, extensions, infobase, external, run, **test**, **dependencies**, **support**, **setversion**, **config**, mcp. Идентификатор команды: `1c-platform-tools.<domain>.<action>`.

Так агенты (и MCP, который получает список команд динамически) смогут предлагать вызов новой команды. Правило: новая команда в дереве → обновить полный SKILL.md и при необходимости доменный SKILL.md.
